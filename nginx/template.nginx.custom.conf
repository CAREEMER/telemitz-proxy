# Shared dictionary для кэша вайтлиста (10MB)
lua_shared_dict whitelist_cache 10m;

server {
    listen 443 ssl http2;
    server_name ${PROXY_DOMAIN};

    include resty-server-https.conf;

    location / {
        set $target_upstream "";

        access_by_lua_block {
            local http = require "resty.http"
            local cjson = require "cjson"
            local cache = ngx.shared.whitelist_cache

            -- 1. Читаем ?target=IP из query string
            local args = ngx.req.get_uri_args()
            local target_ip = args["target"]

            if not target_ip then
                ngx.log(ngx.ERR, "Missing target param")
                ngx.exit(400)
            end

            -- 2. Проверяем кэш whitelist
            local allowed_json = cache:get("global_allowed_nodes")

            if not allowed_json then
                -- Cache MISS: запрашиваем whitelist у backend
                local httpc = http.new()
                httpc:set_timeout(5000) -- 5 сек таймаут

                local res, err = httpc:request_uri("${BACKEND_API_URL}/api/v2/proxy/whitelist", {
                    method = "GET",
                    ssl_verify = false,
                    headers = {
                        ["X-Internal-Secret"] = "${API_SECRET}",
                        ["Content-Type"] = "application/json"
                    }
                })

                if not res then
                    ngx.log(ngx.ERR, "Backend connection failed: ", err)
                    ngx.exit(502)
                end

                if res.status ~= 200 then
                    ngx.log(ngx.ERR, "Backend returned error: ", res.status, " body: ", res.body)
                    ngx.exit(503)
                end

                allowed_json = res.body
                -- Кэшируем на 60 секунд
                cache:set("global_allowed_nodes", allowed_json, 60)
            end

            -- 3. Валидация target IP против whitelist
            local allowed_list = cjson.decode(allowed_json)
            local is_valid = false

            for _, allowed_ip in ipairs(allowed_list) do
                if allowed_ip == target_ip then
                    is_valid = true
                    break
                end
            end

            if not is_valid then
                ngx.log(ngx.WARN, "Blocked unauthorized target: " .. target_ip)
                ngx.exit(403)
            end

            -- 4. Устанавливаем upstream для proxy_pass
            ngx.var.target_upstream = target_ip
        }

        # Проксируем WebSocket на порт 7880 выбранного LiveKit сервера
        proxy_pass http://$target_upstream:7880;

        # WebSocket headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket timeouts
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }
}